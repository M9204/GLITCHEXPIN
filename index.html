<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense and Income Tracker</title>
<style>
body {
  font-family: "Roboto", Arial, sans-serif;
  background: #f1f3f4;
  margin: 0; padding:0;
}
.container {
  width: 90%; max-width: 900px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h1 { text-align:center; margin-bottom:20px; }
#auth-section { text-align:center; margin-bottom:20px; }
#auth-section button { margin:5px; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; background:#1a73e8; color:white; font-size:14px; }
#auth-section button:hover { background:#1558b0; }
.totals { display:flex; justify-content:space-around; margin-bottom:20px; }
.green{color:green;} .red{color:red;}
.form-container { margin-bottom:20px; }
.form-group { margin:10px 0; }
.form-group label { display:block; margin-bottom:4px; font-weight:bold; }
.form-group input, .form-group select, .form-group textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
textarea{resize:vertical;}
.buttons{margin-top:10px;}
.buttons button{margin:5px; padding:10px 15px; border:none; border-radius:6px; cursor:pointer; background:#1a73e8;color:white;font-size:14px;}
.buttons button:hover{background:#1558b0;}
.table-container{overflow-x:auto;}
table{width:100%; border-collapse:collapse;}
table th, table td{padding:8px;border:1px solid #ddd;text-align:center;}
</style>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
<!-- JWT Decode -->
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="container">
  <h1>Expense and Income Tracker</h1>

  <!-- Auth -->
  <div id="auth-section">
    <div id="login"></div>
    <div id="user-info" style="display:none;">
      <p>Welcome <span id="userEmail"></span> <button onclick="logout()">Logout</button></p>
    </div>
  </div>

  <!-- Totals -->
  <div class="totals">
    <h3>Total Income: <span id="totalIncome" class="green">$0.00</span></h3>
    <h3>Total Expenses: <span id="totalExpenses" class="red">$0.00</span></h3>
    <h3>Net Total: <span id="netTotal">$0.00</span></h3>
  </div>

  <!-- Form -->
  <div class="form-container" id="app" style="display:none;">
    <div class="form-group">
      <label>Title:</label>
      <input type="text" id="title" placeholder="Enter Title">
    </div>
    <div class="form-group">
      <label>Date:</label>
      <input type="date" id="date">
    </div>
    <div class="form-group">
      <label>Amount:</label>
      <input type="number" id="amount" step="0.01" min="0">
    </div>
    <div class="form-group">
      <label>Source:</label>
      <select id="source">
        <option value="">Select source</option>
        <option value="mine">Mine</option>
        <option value="company">Company</option>
        <option value="others">Others</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes:</label>
      <textarea id="notes" placeholder="Enter Notes"></textarea>
    </div>
    <div class="buttons">
      <button onclick="setEntryType('income')">Add Income</button>
      <button onclick="setEntryType('expense')">Add Expense</button>
      <button onclick="resetForm()">Clear</button>
      <button onclick="exportToExcel()">Export Excel</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Select</th><th>Date</th><th>Title</th><th>Amount</th><th>Source</th><th>Status</th><th>Notes</th>
        </tr>
      </thead>
      <tbody id="entriesTableBody"></tbody>
    </table>
  </div>
</div>

<script>
const CLIENT_ID = "4870239215-m0sg6fkgnl7dd925l22efedcq9lfds8h.apps.googleusercontent.com";
const ALLOWED_USERS = ["cloudyskyqa@gmail.com"]; // put allowed users here
let entries = [];

function handleCredentialResponse(response){
  const data = jwt_decode(response.credential);
  if(!ALLOWED_USERS.includes(data.email)){ alert("Access denied"); return; }
  localStorage.setItem("id_token", response.credential);
  localStorage.setItem("user", JSON.stringify(data));
  showApp(data);
}

function showApp(user){
  document.getElementById("app").style.display="block";
  document.getElementById("login").style.display="none";
  document.getElementById("user-info").style.display="block";
  document.getElementById("userEmail").innerText=user.email;
}

function logout(){
  localStorage.removeItem("id_token");
  localStorage.removeItem("user");
  document.getElementById("app").style.display="none";
  document.getElementById("login").style.display="block";
  document.getElementById("user-info").style.display="none";
}

window.onload = function(){
  const user = localStorage.getItem("user");
  if(user){ showApp(JSON.parse(user)); }

  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: true,
    cancel_on_tap_outside: false
  });
  google.accounts.id.renderButton(document.getElementById("login"), { theme:"outline", size:"large" });
  google.accounts.id.prompt();
}

// --- App logic ---
function setEntryType(type){
  const entry = {
    date:document.getElementById("date").value,
    title:document.getElementById("title").value,
    amount:parseFloat(document.getElementById("amount").value || 0),
    source:document.getElementById("source").value,
    status:type,
    notes:document.getElementById("notes").value
  };
  entries.push(entry);
  localStorage.setItem("entries", JSON.stringify(entries));
  renderTable();
  resetForm();
}

function renderTable(){
  const tbody=document.getElementById("entriesTableBody");
  tbody.innerHTML="";
  let totalIncome=0,totalExpenses=0;
  entries.forEach(e=>{
    tbody.innerHTML+=`<tr>
      <td><input type="checkbox"></td>
      <td>${e.date}</td><td>${e.title}</td><td>${e.amount.toFixed(2)}</td>
      <td>${e.source}</td><td>${e.status}</td><td>${e.notes}</td>
    </tr>`;
    if(e.status==="income") totalIncome+=e.amount;
    else if(e.status==="expense") totalExpenses+=e.amount;
  });
  document.getElementById("totalIncome").innerText="$"+totalIncome.toFixed(2);
  document.getElementById("totalExpenses").innerText="$"+totalExpenses.toFixed(2);
  document.getElementById("netTotal").innerText="$"+(totalIncome-totalExpenses).toFixed(2);
}

function resetForm(){
  document.getElementById("title").value="";
  document.getElementById("date").value="";
  document.getElementById("amount").value="";
  document.getElementById("source").value="";
  document.getElementById("notes").value="";
}

function exportToExcel(){
  let ws=XLSX.utils.json_to_sheet(entries);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Entries");
  XLSX.writeFile(wb,"expenses.xlsx");
}

// Load entries from localStorage on refresh
window.addEventListener("load",()=>{
  const saved = localStorage.getItem("entries");
  if(saved){ entries = JSON.parse(saved); renderTable(); }
});
</script>

</body>
</html>
